<!DOCTYPE html>
{% extends "base_file.html" %}
{% block title %}LeaveCal - Calendar{% endblock %}

    {% block head_elements %}

    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% get_static_prefix %}/fullcalendar.css">
    <script src="{% get_static_prefix %}/moment.min.js"></script>
    <script src="{% get_static_prefix %}/fullcalendar.js"></script>

    {% endblock head_elements %}

    {% block calendar_active %}active{% endblock %}


{% block content %}

     <div class="row">
            <div class="col-xs-12">
                <h1 id="login_content" name="request_leave_title" align="center">CALENDAR</h1>
            </div>
        </div>

     <div class="container col-md-10 col-xs-10 col-md-offset-1 col-xs-offset-1" id="calendar_container_one">
        <div class="row">
            <div class="panel panel-default" id="calendar_container_two">
                <div align="right" class="button-padding">
                    <button type="button" class="btn btn-success btn-lg" data-toggle="modal" data-target="#requestLeaveModal" align="right">
                        Request Leave
                    </button>
                </div>

                <div id="container_padding">
                     <div id='calendar'>
                     </div>
                </div>
            </div>
        </div>
     </div>




     <!-- Modal To Submit Leave Request -->
                <div class="modal fade" id="requestLeaveModal" tabindex="-1"  role="dialog" aria-labelledby="myModalLabel">
                  <div class="modal-dialog" role="document">
                    <div class="modal-content">
                      <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="myModalLabel">Request Leave</h4>
                      </div>
                      <div class="modal-body">

                              <form id="eventForm" onsubmit="return false" class="form-horizontal" role="form">{% csrf_token %}
                                    <div class="form-group">
                                        <label class="col-md-3 control-label">Leave Type</label>
                                          <div class="col-md-5">
                                                <select class="form-control" id="leaveType" name="leaveType" required>
                                                    <option>Annual Leave</option>
                                                    <option>Sick Leave</option>
                                                    <option>Parental Leave</option>
                                                    <option>Compassionate Leave</option>
                                                    <option>Leave in Lieu</option>
                                                    <option>Other Leave</option>
                                                </select>
                                          </div>
                                    </div>

                                    <div class="form-group has-feedback">
                                        <label for="start_date" class="col-md-3 control-label">Start Date</label>
                                        <div class="col-md-5">
                                            <div class="input-group input-append date" id="datePicker_1">
                                                <input id="start_date" type="text" class="form-control" name="start_date" required pattern="^(?:(?:31(\/|-|\.)(?:0?[13578]|1[02]))\1|(?:(?:29|30)(\/|-|\.)(?:0?[1,3-9]|1[0-2])\2))(?:(?:1[6-9]|[2-9]\d)?\d{2})$|^(?:29(\/|-|\.)0?2\3(?:(?:(?:1[6-9]|[2-9]\d)?(?:0[48]|[2468][048]|[13579][26])|(?:(?:16|[2468][048]|[3579][26])00))))$|^(?:0?[1-9]|1\d|2[0-8])(\/|-|\.)(?:(?:0?[1-9])|(?:1[0-2]))\4(?:(?:1[6-9]|[2-9]\d)?\d{2})$" placeholder="DD/MM/YYYY"/>
                                                <span class="input-group-addon add-on"><span class="glyphicon glyphicon-calendar"></span></span>
                                                <span class="glyphicon form-control-feedback" aria-hidden="true"></span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-group has-feedback">
                                        <label for="startDateStartTime" class="col-md-3 control-label">Start Time</label>
                                         <div class="col-md-5">
                                             <select class="form-control" id="startDateStartTime" name="startDateStartTime">
                                                <option>Beginning of Day</option>
                                                <option>Lunchtime</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="form-group has-feedback">
                                        <label for="end_date" class="col-md-3 control-label">End Date</label>
                                        <div class="col-md-5 date">
                                            <div class="input-group input-append date" id="datePicker_2">
                                                <input type="text" class="form-control" id="end_date" name="end_date"  placeholder="DD/MM/YYYY"/>
                                                <span class="input-group-addon add-on"><span class="glyphicon glyphicon-calendar"></span></span>
                                                <span class="glyphicon form-control-feedback" aria-hidden="true"></span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-group has-feedback">
                                        <label for="endDateEndTime" class="col-md-3 control-label">End Time</label>
                                        <div class="col-md-5">
                                             <select class="form-control" id="endDateEndTime" name="endDateEndTime">
                                                <option>End of Day</option>
                                                <option>Lunchtime</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="col-md-3 control-label">Reason</label>
                                          <div class="col-md-5">
                                              <textarea class="form-control" rows="5" id="leaveReason" name="leaveReason"></textarea>
                                          </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="col-md-3 control-label">Approval Type</label>
                                          <div class="col-md-5">
                                            <div class="radio">
                                                <label><input type="radio" name="optradio" value="Manager">Manager</label>
                                            </div>
                                            <div class="radio">
                                                <label><input type="radio" name="optradio" value="Team">Team</label>
                                            </div>
                                          </div>
                                    </div>

                                     <div class="form-group">
                                        <div class="col-md-9 col-md-offset-3">
                                            <div id="messages"/></div>
                                        </div>
                                     </div>

                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                                        <button type="submit" id="submitButton" class="btn btn-primary" data_toggle="validator" >Submit</button>
                                    </div>
                            </form>
                      </div>
                    </div>
                  </div>
                </div>
{% endblock %}

{% block scripts %}
<script>
	$(document).ready(function() {

	    $.loader.open();

		$('#calendar').fullCalendar({
			header: {
				left: 'prev,next today',
				center: 'title',
				right: 'month,agendaWeek,agendaDay'
			},
			editable: false,
			eventLimit: true,
		});

		getCalendarEvents();
		getDatePickers();
		getValidators();


	});

	function getCalendarEvents(){

        $.ajax({
            type: "GET",
            url: "/calendar/getevents/",
            success: function(data){
                $.each(data, function(i, event_detail){

                    var start_date_test = "";
                    var end_date_test = "";
                    var all_day = "true";
                    var start_date_month = "";
                    var start_date_year = "";
                    var start_date_day = "";
                    var start_date_time;
                    var leave_type;

                    var leave_type = event_detail["title"];
                    var start_date = event_detail["start_date"];
                    var end_date = event_detail["end_date"];
                    var start_time = event_detail["start_time"];
                    var end_time = event_detail["end_time"];

                    if (start_time == "Lunchtime"){

                        all_day = false;
                        start_date_test = $.fullCalendar.moment(start_date.concat(' 13:00'));
                        }else{
                            start_date_test = start_date;
                        }

                    if (end_time == "Lunchtime"){
                        all_day = false;
                        end_date_test = $.fullCalendar.moment(end_date.concat(' 13:00'));
                    }else{
                        end_date_test = end_date;
                    }

                    var backgroundColourOfEvent = "";

                    if(leave_type == "Annual Leave"){
                        backgroundColourOfEvent = 'green';
                    }
                    else if(leave_type == "Sick Leave"){
                        backgroundColourOfEvent = '#ED1317';
                    }
                    else if(leave_type == "Compassionate Leave"){
                        backgroundColourOfEvent = 'black';
                    }
                    else if(leave_type == "Parental Leave"){
                        backgroundColourOfEvent = 'yellow';
                    }
                    else if(leave_type == "Leave in Lieu"){
                        backgroundColourOfEvent = 'orange';
                    }
                    else if(leave_type == "Other Leave"){
                        backgroundColourOfEvent = 'blue';
                    }

                    var myEvent = {
                          title:leave_type.concat(" - ").concat(start_date).concat(" to ").concat(end_date),
                          allDay: all_day,
                          start: start_date_test,
                          end: end_date_test,
                          backgroundColor: backgroundColourOfEvent
                        };

                    $('#calendar').fullCalendar( 'renderEvent', myEvent, true );
                });

            },
            complete : function (){
                $.loader.close();
            }
        });

	}

	function getDatePickers(){
	    var today = new Date();
        var dd = today.getDate();

       $('#start_date').daterangepicker({
            "singleDatePicker": true,
            "locale": {
                "format": "DD/MM/YYYY",
                "separator": " - ",
                "applyLabel": "Apply",
                "cancelLabel": "Cancel",
                "fromLabel": "From",
                "toLabel": "To",
                "customRangeLabel": "Custom",
                "daysOfWeek": [
                    "Su",
                    "Mo",
                    "Tu",
                    "We",
                    "Th",
                    "Fr",
                    "Sa"
                ],
                "monthNames": [
                    "January",
                    "February",
                    "March",
                    "April",
                    "May",
                    "June",
                    "July",
                    "August",
                    "September",
                    "October",
                    "November",
                    "December"
                ],
                "firstDay": 1
            },
            "startDate": dd
        });

        $('#end_date').daterangepicker({
            "singleDatePicker": true,
            "locale": {
                "format": "DD/MM/YYYY",
                "separator": " - ",
                "applyLabel": "Apply",
                "cancelLabel": "Cancel",
                "fromLabel": "From",
                "toLabel": "To",
                "customRangeLabel": "Custom",
                "daysOfWeek": [
                    "Su",
                    "Mo",
                    "Tu",
                    "We",
                    "Th",
                    "Fr",
                    "Sa"
                ],
                "monthNames": [
                    "January",
                    "February",
                    "March",
                    "April",
                    "May",
                    "June",
                    "July",
                    "August",
                    "September",
                    "October",
                    "November",
                    "December"
                ],
                "firstDay": 1
            },
            "startDate": dd
        });
	}

	function getValidators(){
	            $('#eventForm').bootstrapValidator({
        framework: 'bootstrap',
        button: {
            selector: '#submitButton',
        },
        container: '#messages',
        live: 'enabled',
        feedbackIcons: {
            valid: 'glyphicon glyphicon-ok',
            invalid: 'glyphicon glyphicon-remove',
            validating: 'glyphicon glyphicon-refresh'
        },
        fields: {
            start_date: {
                validators: {
                    notEmpty: {
                        message: 'The start date is required and cannot be empty'
                    }
                }
            },
            startDateStartTime: {
                validators: {
                    notEmpty: {
                        message: 'The start date is required and cannot be empty'
                    },
                    callback: {
                        callback: function (value, validator, $field) {

                            var startDate = $("#start_date").val();
                            var endDate = $("#end_date").val();
                            var endDateTime = $("#endDateEndTime").val();
                            var startDateTime = $("#startDateStartTime").val();

                            startDate = new Date(startDate);
                            endDate = new Date(endDate);

                            if (startDate == endDate){
                                alert("dates are the same");
                                if(endDateTime == "Lunchtime" && startDateTime == "Lunchtime"){
                                   alert("same date and both equal lunchtime");
                                        return {
                                            valid: false,
                                            message: 'Leave cannot start and finish at the same time on the same day.'
                                        }
                                }
                                else {
                                    return {
                                            valid: true
                                        }
                                }
                            }
                            else{
                                return {
                                            valid: true
                                        }
                            }
                        }
                    }
                }
            },
            end_date: {
                validators: {
                    notEmpty: {
                        message: 'The end date is required and cannot be empty'
                    },
                    callback: {
                        callback: function (value, validator, $field) {

                            var startDate = $("#start_date").val();
                            var endDate = $("#end_date").val();

                            //alert("start Date " + startDate);
                            //alert("end Date " + endDate);

                            //alert("start Date " + Date.parse(startDate));
                            //alert("end Date " + Date.parse(endDate));


                            if (endDate <= startDate){
                                //alert("end date less than start date");
                                return {
                                            valid: false,
                                            message: 'Start date has to be earlier than or equal to the end date'
                                        }
                            }
                            else {
                                //alert("date is fine now");
                                return {
                                    valid: true
                                }
                            }
                        }
                    }
                }
            },
            endDateEndTime: {
                validators: {
                    notEmpty: {
                        message: 'The end time is required and cannot be empty'
                    },
                    callback: {
                        callback: function (value, validator, $field) {

                            var startDate = $("#start_date").val();
                            var endDate = $("#end_date").val();
                            var endDateTime = $("#endDateEndTime").val();
                            var startDateTime = $("#startDateStartTime").val();

                            startDate = new Date(startDate);
                            endDate = new Date(endDate);

                            if (startDate == endDate){
                                alert("dates are the same");
                                if(endDateTime == "Lunchtime" && startDateTime == "Lunchtime"){
                                   alert("same date and both equal lunchtime");
                                        return {
                                            valid: false,
                                            message: 'Leave cannot start and finish at the same time on the same day.'
                                        }
                                }
                                else {
                                    return {
                                            valid: true
                                        }
                                }
                            }
                            else{
                                return {
                                            valid: true
                                        }
                            }
                        }
                    }
                }
            },
            leaveReason: {
                validators: {
                    stringLength: {
                        max: 300,
                        message: 'The Reason must be less than 300 characters long'
                    }
                }
            },
            leaveType: {
                validators: {
                    notEmpty: {
                        message: 'The type of leave is required and cannot be empty'
                    },
                    stringLength: {
                        max: 70,
                        message: 'The leave type must be less than 70 characters long'
                    }
                }
            },
            optradio: {
                validators: {
                    notEmpty: {
                        message: 'The content is required and cannot be empty'
                    },
                }
            },
        },

    })
    .on('init.form.bv', function(e, data) {
        alert("IM GETTING IN INITIALISE FORM");
        validator.disableSubmitButtons(false);
    })
    .on('success.form.bv', function(e, data) {
        // Prevent form submission
        e.preventDefault();

        var $form        = $(e.target),
            validator    = $form.data('bootstrapValidator'),
            submitButton = validator.getSubmitButton();


        validator.disableSubmitButtons(true);

        sendLeaveRequest();
    })
    .on('err.form.bv', function(e, data) {
         alert("Finding errors in the form");
         $(form).data('formValidation').resetForm();
    });
	}

	function sendLeaveRequest(){

        var leaveType = document.getElementById("leaveType").value;
        var start_date = document.getElementById("start_date").value;
        var end_date = document.getElementById("end_date").value;
        var start_date_start_time = document.getElementById("startDateStartTime").value;
        var end_date_start_time = document.getElementById("endDateEndTime").value;
        var leave_reason = document.getElementById("leaveReason").value;
        var approval_type = $('input[name="optradio"]:checked').val();

        $.ajax({
                type: "POST",
                url: "/dashboard/submitrequest/",
                async: true,
                data: {
                    leaveType: leaveType,
                    start_date: start_date,
                    end_date: end_date,
                    start_date_start_time: start_date_start_time,
                    end_date_start_time: end_date_start_time,
                    leave_reason: leave_reason,
                    approval_type: approval_type
                },

                beforeSend: function(data){

                },

                success: function(data){

                        if(data[0] == "unsucessful"){
                            $('#requestLeaveModal').modal('hide');
                            $('#postSubmissionModalUnsuccessful').modal('show');

                            var reasonValue =  document.getElementById("ReasonValue");
                            reasonValue.innerHTML = data[1];
                        }
                        else {
                            $('#requestLeaveModal').modal('hide');
                            $('#postSubmissionModal').modal('show');

                            var leaveTypeValue =  document.getElementById("LeaveTypeValue");
                            leaveTypeValue.innerHTML = leaveType;

                            var startDateValue =  document.getElementById("startDateValue");
                            startDateValue.innerHTML = start_date;

                            var endDateValue =  document.getElementById("endDateValue");
                            endDateValue.innerHTML = end_date;

                            var startTimeValue =  document.getElementById("startTimeValue");
                            startTimeValue.innerHTML = start_date_start_time;

                            var endTimeValue =  document.getElementById("endTimeValue");
                            endTimeValue.innerHTML = end_date_start_time;

                            var leaveReasonValue =  document.getElementById("leaveReasonValue");
                            leaveReasonValue.innerHTML = leave_reason;
                        }
                },

                failure: function(response, opts) {
                    console.log('server-side failure: ' + response);
                },
        });

    }
</script>

{% endblock %}