<!DOCTYPE html>
{% extends "base_file.html" %}
{% block title %}LeaveCal - Current Requests{% endblock %}

{% block user_requests_active %}active{% endblock %}
{% block content %}
        <div class="row">
            <div class="col-md-12">
                <h1 id="login_content" name="your_requests_title" align="center">YOUR REQUESTS</h1>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12">
                <h3 id="login_content" name="request_leave_title" align="center">Your current Leave Requests are shown below</h3>
            </div>
        </div>

        <div class="row">
            <div class="container panel panel-default col-md-10 col-xs-10 col-md-offset-1 col-xs-offset-1">
                <div class="panel-group" align="right">
                    <button type="button" class="btn btn-success btn-lg" data-toggle="modal" data-target="#requestLeaveModal">
                        Request Leave
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="personalRequestsTable">
                    <thead>
                      <tr>
                        <th><h3>Leave Type</h3></th>
                        <th><h3>Start Date</h3></th>
                        <th><h3>Start Time</h3></th>
                        <th><h3>End Date</h3></th>
                        <th><h3>End Time</h3></th>
                        <th><h3>Reason</h3></th>
                        <th><h3>Status</h3></th>
                        <th><h3>Cancel</h3></th>
                      </tr>
                    </thead>
                    <tbody>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
        </div>

{% endblock %}

{% block scripts %}
<script>

    $(document).ready(function() {
        getUserRequestsAjax();
        getDatePickers();
		getValidators();
    });

    function getUserRequestsAjax(){

        $.ajax({
                type: "GET",
                url: "/userrequests/getuserrequests/",
                beforeSend: function(data){
                    $.loader.open();
                },
                success: function(data){
                    $.each(data, function(i, event_detail){

                        var start_date_test = "";
                        var end_date_test = "";
                        var all_day = "true";
                        var start_date_month = "";
                        var start_date_year = "";
                        var start_date_day = "";
                        var start_date_time;
                        var fullname;

                        var first_name = event_detail["first_name"];
                        var title = event_detail["title"];
                        var surname = event_detail["surname"];
                        var start_date = event_detail["start_date"];
                        var end_date = event_detail["end_date"];
                        var start_time = event_detail["start_time"];
                        var end_time = event_detail["end_time"];
                        var reason = event_detail["reason"];
                        var status = event_detail["status"];
                        var leave_id = event_detail["leave_id"];

                        var table = document.getElementById("personalRequestsTable");

                        var row = table.insertRow(i+1);

                        var table_title = row.insertCell(0);
                        var table_start_date = row.insertCell(1);
                        var table_start_time = row.insertCell(2);
                        var table_end_date = row.insertCell(3);
                        var table_end_time = row.insertCell(4);
                        var table_reason = row.insertCell(5);
                        var table_status = row.insertCell(6);
                        var table_response = row.insertCell(7);

                        table_title.innerHTML = title;
                        table_start_date.innerHTML = start_date;
                        table_start_time.innerHTML = start_time;
                        table_end_date.innerHTML = end_date;
                        table_end_time.innerHTML = end_time;
                        table_reason.innerHTML = reason;
                        table_status.innerHTML = status;

                        addFormElements(table_response, leave_id);

                    });
                },
                complete : function (){
                    $.loader.close();
                }
            });
    }

    function addFormElements(table_response, leave_id){

                var approval_form = document.createElement("form");
                approval_form.setAttribute('onsubmit',"return false;");

                var cancelled_button = document.createElement("input");

                cancelled_button.setAttribute('type',"button");
                cancelled_button.setAttribute('id',("Cancel" + leave_id));
                cancelled_button.setAttribute('value',"Cancel");
                cancelled_button.setAttribute('class',"btn btn-danger");
                cancelled_button.setAttribute('name',"cancel_button");
                cancelled_button.setAttribute('leave_id',leave_id);
                cancelled_button.setAttribute('onClick',"setApprovalStatus(this);");

                var hidden_field = document.createElement("input"); //input element, text
                hidden_field.setAttribute('type',"hidden");
                hidden_field.setAttribute('name',"leave_id");
                hidden_field.setAttribute('value',leave_id);

                cancelled_button.appendChild(hidden_field);

                approval_form.appendChild(cancelled_button);
                approval_form.appendChild(hidden_field);

                table_response.appendChild(approval_form);
    }


    function setApprovalStatus(calling_element){

        var current_leave_id = document.getElementById(calling_element.id).getAttribute("leave_id");
        var current_name = document.getElementById(calling_element.id).getAttribute("name");

        $.ajax({
                type: "POST",
                url: "/event/cancelled/",
                async: true,
                data: {
                    leave_id: current_leave_id,
                    name: current_name,
                },

                beforeSend: function(data){
                    $.loader.open();
                },

                success: function(data){
                    $.loader.close();
                    getUserRequestsAjax();
                },

                failure: function(response, opts) {
                    console.log('server-side failure: ' + response);
                },
        });
    }
    	function getDatePickers(){
	    var today = new Date();
        var dd = today.getDate();

       $('#start_date').daterangepicker({
            "singleDatePicker": true,
            "locale": {
                "format": "DD/MM/YYYY",
                "separator": " - ",
                "applyLabel": "Apply",
                "cancelLabel": "Cancel",
                "fromLabel": "From",
                "toLabel": "To",
                "customRangeLabel": "Custom",
                "daysOfWeek": [
                    "Su",
                    "Mo",
                    "Tu",
                    "We",
                    "Th",
                    "Fr",
                    "Sa"
                ],
                "monthNames": [
                    "January",
                    "February",
                    "March",
                    "April",
                    "May",
                    "June",
                    "July",
                    "August",
                    "September",
                    "October",
                    "November",
                    "December"
                ],
                "firstDay": 1
            },
            "startDate": dd
        });

        $('#end_date').daterangepicker({
            "singleDatePicker": true,
            "locale": {
                "format": "DD/MM/YYYY",
                "separator": " - ",
                "applyLabel": "Apply",
                "cancelLabel": "Cancel",
                "fromLabel": "From",
                "toLabel": "To",
                "customRangeLabel": "Custom",
                "daysOfWeek": [
                    "Su",
                    "Mo",
                    "Tu",
                    "We",
                    "Th",
                    "Fr",
                    "Sa"
                ],
                "monthNames": [
                    "January",
                    "February",
                    "March",
                    "April",
                    "May",
                    "June",
                    "July",
                    "August",
                    "September",
                    "October",
                    "November",
                    "December"
                ],
                "firstDay": 1
            },
            "startDate": dd
        });
	}

	function getValidators(){
	            $('#eventForm').bootstrapValidator({
        framework: 'bootstrap',
        button: {
            selector: '#submitButton',
        },
        container: '#messages',
        live: 'enabled',
        feedbackIcons: {
            valid: 'glyphicon glyphicon-ok',
            invalid: 'glyphicon glyphicon-remove',
            validating: 'glyphicon glyphicon-refresh'
        },
        fields: {
            start_date: {
                validators: {
                    notEmpty: {
                        message: 'The start date is required and cannot be empty'
                    }
                }
            },
            startDateStartTime: {
                validators: {
                    notEmpty: {
                        message: 'The start date is required and cannot be empty'
                    },
                    callback: {
                        callback: function (value, validator, $field) {

                            var startDate = $("#start_date").val();
                            var endDate = $("#end_date").val();
                            var endDateTime = $("#endDateEndTime").val();
                            var startDateTime = $("#startDateStartTime").val();

                            startDate = new Date(startDate);
                            endDate = new Date(endDate);

                            if (startDate == endDate){
                                alert("dates are the same");
                                if(endDateTime == "Lunchtime" && startDateTime == "Lunchtime"){
                                   alert("same date and both equal lunchtime");
                                        return {
                                            valid: false,
                                            message: 'Leave cannot start and finish at the same time on the same day.'
                                        }
                                }
                                else {
                                    return {
                                            valid: true
                                        }
                                }
                            }
                            else{
                                return {
                                            valid: true
                                        }
                            }
                        }
                    }
                }
            },
            end_date: {
                validators: {
                    notEmpty: {
                        message: 'The end date is required and cannot be empty'
                    },
                    callback: {
                        callback: function (value, validator, $field) {

                            var startDate = $("#start_date").val();
                            var endDate = $("#end_date").val();

                            //alert("start Date " + startDate);
                            //alert("end Date " + endDate);

                            //alert("start Date " + Date.parse(startDate));
                            //alert("end Date " + Date.parse(endDate));


                            if (endDate <= startDate){
                                //alert("end date less than start date");
                                return {
                                            valid: false,
                                            message: 'Start date has to be earlier than or equal to the end date'
                                        }
                            }
                            else {
                                //alert("date is fine now");
                                return {
                                    valid: true
                                }
                            }
                        }
                    }
                }
            },
            endDateEndTime: {
                validators: {
                    notEmpty: {
                        message: 'The end time is required and cannot be empty'
                    },
                    callback: {
                        callback: function (value, validator, $field) {

                            var startDate = $("#start_date").val();
                            var endDate = $("#end_date").val();
                            var endDateTime = $("#endDateEndTime").val();
                            var startDateTime = $("#startDateStartTime").val();

                            startDate = new Date(startDate);
                            endDate = new Date(endDate);

                            if (startDate == endDate){
                                alert("dates are the same");
                                if(endDateTime == "Lunchtime" && startDateTime == "Lunchtime"){
                                   alert("same date and both equal lunchtime");
                                        return {
                                            valid: false,
                                            message: 'Leave cannot start and finish at the same time on the same day.'
                                        }
                                }
                                else {
                                    return {
                                            valid: true
                                        }
                                }
                            }
                            else{
                                return {
                                            valid: true
                                        }
                            }
                        }
                    }
                }
            },
            leaveReason: {
                validators: {
                    stringLength: {
                        max: 300,
                        message: 'The Reason must be less than 300 characters long'
                    }
                }
            },
            leaveType: {
                validators: {
                    notEmpty: {
                        message: 'The type of leave is required and cannot be empty'
                    },
                    stringLength: {
                        max: 70,
                        message: 'The leave type must be less than 70 characters long'
                    }
                }
            },
            optradio: {
                validators: {
                    notEmpty: {
                        message: 'The content is required and cannot be empty'
                    },
                }
            },
        },

    })
    .on('init.form.bv', function(e, data) {
        alert("IM GETTING IN INITIALISE FORM");
        validator.disableSubmitButtons(false);
    })
    .on('success.form.bv', function(e, data) {
        // Prevent form submission
        e.preventDefault();

        var $form        = $(e.target),
            validator    = $form.data('bootstrapValidator'),
            submitButton = validator.getSubmitButton();


        validator.disableSubmitButtons(true);

        sendLeaveRequest();
    })
    .on('err.form.bv', function(e, data) {
         alert("Finding errors in the form");
         $(form).data('formValidation').resetForm();
    });
	}

	function sendLeaveRequest(){

        var leaveType = document.getElementById("leaveType").value;
        var start_date = document.getElementById("start_date").value;
        var end_date = document.getElementById("end_date").value;
        var start_date_start_time = document.getElementById("startDateStartTime").value;
        var end_date_start_time = document.getElementById("endDateEndTime").value;
        var leave_reason = document.getElementById("leaveReason").value;
        var approval_type = $('input[name="optradio"]:checked').val();

        $.ajax({
                type: "POST",
                url: "/dashboard/submitrequest/",
                async: true,
                data: {
                    leaveType: leaveType,
                    start_date: start_date,
                    end_date: end_date,
                    start_date_start_time: start_date_start_time,
                    end_date_start_time: end_date_start_time,
                    leave_reason: leave_reason,
                    approval_type: approval_type
                },

                beforeSend: function(data){

                },

                success: function(data){

                        if(data[0] == "unsucessful"){
                            $('#requestLeaveModal').modal('hide');
                            $('#postSubmissionModalUnsuccessful').modal('show');

                            var reasonValue =  document.getElementById("ReasonValue");
                            reasonValue.innerHTML = data[1];
                        }
                        else {
                            $('#requestLeaveModal').modal('hide');
                            $('#postSubmissionModal').modal('show');

                            var leaveTypeValue =  document.getElementById("LeaveTypeValue");
                            leaveTypeValue.innerHTML = leaveType;

                            var startDateValue =  document.getElementById("startDateValue");
                            startDateValue.innerHTML = start_date;

                            var endDateValue =  document.getElementById("endDateValue");
                            endDateValue.innerHTML = end_date;

                            var startTimeValue =  document.getElementById("startTimeValue");
                            startTimeValue.innerHTML = start_date_start_time;

                            var endTimeValue =  document.getElementById("endTimeValue");
                            endTimeValue.innerHTML = end_date_start_time;

                            var leaveReasonValue =  document.getElementById("leaveReasonValue");
                            leaveReasonValue.innerHTML = leave_reason;
                        }
                },

                failure: function(response, opts) {
                    console.log('server-side failure: ' + response);
                },
        });

    }
</script>
{% endblock %}
